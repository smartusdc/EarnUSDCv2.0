<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeFi Platform</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        .button:disabled {
            background-color: #cccccc;
        }
        .error {
            color: red;
            margin-top: 5px;
        }
        .success {
            color: green;
            margin-top: 5px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
        }
        .input-group input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            width: 200px;
        }
    </style>
</head>
<body>
    <h1>DeFi Platform</h1>
    
    <!-- Wallet Connection -->
    <div class="container">
        <button id="connectWallet" class="button">Connect Wallet</button>
        <div id="walletStatus"></div>
    </div>

    <!-- Account Information -->
    <div class="container">
        <h2>Account Information</h2>
        <p>Balance: <span id="userBalance">0</span> USDC</p>
        <p>Current APR: <span id="currentAPR">0</span>%</p>
    </div>

    <!-- Referral Code Section -->
    <div class="container">
        <h2>Referral Code</h2>
        <p>Your Referral Code: <span id="referralCode">-</span></p>
        <button id="copyReferralCode" class="button">Copy Referral Code</button>
    </div>

    <!-- Deposit Section -->
    <div class="container">
        <h2>Deposit</h2>
        <div class="input-group">
            <label for="depositAmount">Amount (USDC):</label>
            <input type="number" id="depositAmount" min="0" step="0.000001">
        </div>
        <div class="input-group">
            <label for="referralCodeInput">Referral Code (optional):</label>
            <input type="text" id="referralCodeInput">
        </div>
        <button id="depositButton" class="button">Deposit</button>
        <div id="depositStatus"></div>
    </div>

    <!-- Withdrawal Section -->
    <div class="container">
        <h2>Withdraw</h2>
        <div class="input-group">
            <label for="withdrawAmount">Amount (USDC):</label>
            <input type="number" id="withdrawAmount" min="0" step="0.000001">
        </div>
        <button id="requestWithdrawButton" class="button">Request Withdrawal</button>
        <button id="withdrawButton" class="button">Execute Withdrawal</button>
        <div id="withdrawStatus"></div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js" 
        integrity="sha512-FwMF6CqP7U6FmyHlrxhBxX0TjmcpMT+zcXL5GRTZVzHzGmBk8+mwD+nEHda8GoVD4XyQQWKiVHmYGqKyVRYtA==" 
        crossorigin="anonymous" 
        referrerpolicy="no-referrer">
</script>
    <script>
        // Configuration
        const contractAddress = "0x9cf81A1814D452D4f5308aA38D128ce5CAADdDE4";
        const contractABI = [
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "_usdcTokenAddress",
                "type": "address"
            }
        ],
        "stateMutability": "nonpayable",
        "type": "constructor"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "amount",
                "type": "uint256"
            },
            {
                "internalType": "uint256",
                "name": "referralCode",
                "type": "uint256"
            }
        ],
        "name": "depositFunds",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "amount",
                "type": "uint256"
            }
        ],
        "name": "requestWithdrawal",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "withdraw",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "generateReferralCode",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "claimDepositReward",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "claimReferralReward",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "cancelWithdrawal",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "userAddress",
                "type": "address"
            }
        ],
        "name": "calculateReward",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "currentAPR",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "name": "deposits",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "user",
                "type": "address"
            },
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "amount",
                "type": "uint256"
            }
        ],
        "name": "Deposit",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "user",
                "type": "address"
            },
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "amount",
                "type": "uint256"
            }
        ],
        "name": "Withdrawal",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "newAPR",
                "type": "uint256"
            }
        ],
        "name": "APRUpdated",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "user",
                "type": "address"
            },
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "referralCode",
                "type": "uint256"
            }
        ],
        "name": "ReferralCodeCreated",
        "type": "event"
    }
];
        
let provider;
let signer;
let contract;
let userAddress;

// Initialize Web3 and Contract
async function initializeWeb3() {
    try {
        console.log("Initializing Web3..."); // デバッグログ

        // MetaMaskが利用可能かチェック
        if (typeof window.ethereum === 'undefined') {
            document.getElementById('walletStatus').innerHTML = 
                '<p class="error">MetaMaskをインストールしてください</p>';
            return;
        }

        // MetaMaskのプロバイダーを取得
        provider = new ethers.providers.Web3Provider(window.ethereum);
        
        // ウォレット接続を要求
        console.log("Requesting accounts..."); // デバッグログ
        const accounts = await window.ethereum.request({ 
            method: 'eth_requestAccounts' 
        });
        
        if (!accounts || accounts.length === 0) {
            throw new Error('ウォレットに接続できませんでした');
        }

        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        console.log("Connected address:", userAddress); // デバッグログ

        // コントラクトのインスタンス化
        contract = new ethers.Contract(contractAddress, contractABI, signer);
        
        // 接続成功のメッセージを表示
        document.getElementById('walletStatus').innerHTML = 
            `<p class="success">接続成功: ${userAddress.substring(0,6)}...${userAddress.substring(38)}</p>`;
        
        // UI更新とイベントリスナーの設定
        await updateUI();
        setupEventListeners();

        // MetaMaskのアカウント変更イベントをリッスン
        window.ethereum.on('accountsChanged', function (accounts) {
            console.log("Account changed, reloading..."); // デバッグログ
            window.location.reload();
        });

        // チェーン変更イベントをリッスン
        window.ethereum.on('chainChanged', function (chainId) {
            console.log("Network changed, reloading..."); // デバッグログ
            window.location.reload();
        });

    } catch (error) {
        console.error('Connection error:', error); // デバッグログ
        document.getElementById('walletStatus').innerHTML = 
            `<p class="error">接続エラー: ${error.message}</p>`;
    }
}

        // UI Update Functions
        async function updateUI() {
            await updateBalance();
            await updateAPR();
            await updateReferralCode();
        }

        async function updateBalance() {
            try {
                const balance = await contract.balanceOf(userAddress);
                document.getElementById('userBalance').textContent = 
                    ethers.utils.formatUnits(balance, 6);
            } catch (error) {
                console.error("Error updating balance:", error);
            }
        }

        async function updateAPR() {
            try {
                const apr = await contract.getCurrentAPR();
                document.getElementById('currentAPR').textContent = 
                    ethers.utils.formatUnits(apr, 2);
            } catch (error) {
                console.error("Error updating APR:", error);
            }
        }

        async function updateReferralCode() {
            try {
                const code = await getReferralCode();
                document.getElementById('referralCode').textContent = code;
            } catch (error) {
                console.error("Error updating referral code:", error);
            }
        }

        // Contract Interaction Functions
        async function depositFunds(amount, referralCode) {
            try {
                const tx = await contract.depositFunds(
                    ethers.utils.parseUnits(amount.toString(), 6),
                    referralCode
                );
                document.getElementById('depositStatus').innerHTML = 
                    '<p class="success">Transaction submitted. Waiting for confirmation...</p>';
                await tx.wait();
                document.getElementById('depositStatus').innerHTML = 
                    '<p class="success">Deposit successful!</p>';
                await updateUI();
            } catch (error) {
                document.getElementById('depositStatus').innerHTML = 
                    `<p class="error">Deposit failed: ${error.message}</p>`;
            }
        }

        async function requestWithdrawal(amount) {
            try {
                const tx = await contract.requestWithdrawal(
                    ethers.utils.parseUnits(amount.toString(), 6)
                );
                document.getElementById('withdrawStatus').innerHTML = 
                    '<p class="success">Withdrawal request submitted. Waiting for confirmation...</p>';
                await tx.wait();
                document.getElementById('withdrawStatus').innerHTML = 
                    '<p class="success">Withdrawal request successful!</p>';
                await updateUI();
            } catch (error) {
                document.getElementById('withdrawStatus').innerHTML = 
                    `<p class="error">Withdrawal request failed: ${error.message}</p>`;
            }
        }

        async function withdraw() {
            try {
                const tx = await contract.withdraw();
                document.getElementById('withdrawStatus').innerHTML = 
                    '<p class="success">Withdrawal submitted. Waiting for confirmation...</p>';
                await tx.wait();
                document.getElementById('withdrawStatus').innerHTML = 
                    '<p class="success">Withdrawal successful!</p>';
                await updateUI();
            } catch (error) {
                document.getElementById('withdrawStatus').innerHTML = 
                    `<p class="error">Withdrawal failed: ${error.message}</p>`;
            }
        }

        async function getReferralCode() {
            try {
                const code = await contract.getReferralCode();
                return code.toString();
            } catch (error) {
                console.error("Error getting referral code:", error);
                return "-";
            }
        }

        // Event Listeners Setup
        function setupEventListeners() {
            // Contract Events
            contract.on("Deposit", async (user, amount, event) => {
                if (user === userAddress) {
                    await updateUI();
                }
            });

            contract.on("Withdrawal", async (user, amount, event) => {
                if (user === userAddress) {
                    await updateUI();
                }
            });

            contract.on("APRUpdated", async (newAPR, event) => {
                await updateAPR();
            });

            // UI Button Events
            document.getElementById('connectWallet').addEventListener('click', initializeWeb3);

            document.getElementById('depositButton').addEventListener('click', async () => {
                const amount = document.getElementById('depositAmount').value;
                const referralCode = document.getElementById('referralCodeInput').value;
                if (amount > 0) {
                    await depositFunds(amount, referralCode);
                }
            });

            document.getElementById('requestWithdrawButton').addEventListener('click', async () => {
                const amount = document.getElementById('withdrawAmount').value;
                if (amount > 0) {
                    await requestWithdrawal(amount);
                }
            });

            document.getElementById('withdrawButton').addEventListener('click', withdraw);

            document.getElementById('copyReferralCode').addEventListener('click', async () => {
                const code = document.getElementById('referralCode').textContent;
                if (code !== "-") {
                    await navigator.clipboard.writeText(code);
                    alert("Referral code copied to clipboard!");
                }
            });
        }

        // Initialize on page load
window.addEventListener('DOMContentLoaded', () => {
    const connectWalletBtn = document.getElementById('connectWallet');
    if (connectWalletBtn) {
        // 初期接続試行
        connectWalletBtn.addEventListener('click', async () => {
            console.log("Connect wallet button clicked"); // デバッグログ
            await initializeWeb3();
        });
        // 自動接続を試みる
        initializeWeb3().catch(console.error);
    }
});
    </script>
</body>
</html>
